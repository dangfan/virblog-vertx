var EN={login:{LOGIN:"Login",USERNAME:"Username",PASSWORD:"Password",WRONG:"Invalid username and password.",ADMIN:"Admin",LOGOUT:"Logout"},LANGUAGE:"Language",SUCCESS:"Success",FAILURE:"Something Wrong. Please try again.",nav:{POSTS:"Posts",PAGES:"Pages",SETTINGS:"Settings",EDIT:"Edit",TAGS:"Tags"},posts:{PUBLISHED:"Published",DRAFT:"Draft",EDIT:"Edit",VIEW:"View",UNPUBLISH:"Unpublish",PUBLISH:"Publish",TRASH:"Trash",CONFIRM_DELETE:"Are you sure you want to confirm this?",ADD:"Add"},settings:{LOCALE_CODE:"Locale Code",DISPLAY_NAME:"Display Name",SET_DEFAULT:"Set As Default",DEFAULT:"(Currently Default)",ADD_LOCALE:"Add a language",DELETE:"Delete",CONFIRM_DELETE:"Are you sure? No data will be removed.",BLOG_NAME:"Blog Name",BLOG_DESCRIPTION:"Blog Description",SAVE:"Save",INFO:"Info",PAGE_SIZE:"Posts Per Page",DATETIME_FORMAT:"Datetime Format"},editor:{TITLE:"Title",SUBTITLE:"Subtitle",SLUG:"Slug",TIME:"Publish Time",EXCERPT:"Excerpt",CONTENT:"Content",ADD_TAG:"Add a tag",SAVE_PUBLISH:"Save & Publish",SAVE_DRAFT:"Save as draft",HEADER_IMAGE:"Header Image",COPY_FROM:"Copy From"},tags:{NAME:"Name",ADD:"Add",ADD_PROMPT:"Please input a new tag slug"}},ZH_HANS={login:{LOGIN:"登录",USERNAME:"用户名",PASSWORD:"密码",WRONG:"用户名或密码错误。",ADMIN:"管理中心",LOGOUT:"退出"},LANGUAGE:"语言",SUCCESS:"成功",FAILURE:"出错了，请重试",nav:{POSTS:"日志",PAGES:"页面",SETTINGS:"设置",EDIT:"编辑",TAGS:"标签",USERS:"用户",BLOGROLLS:"友情链接"},posts:{PUBLISHED:"已发布",DRAFT:"草稿",EDIT:"编辑",VIEW:"查看",UNPUBLISH:"取消发布",PUBLISH:"发布",TRASH:"删除",CONFIRM_DELETE:"您确定要删除吗？",ADD:"新增"},settings:{LOCALE_CODE:"区域代码",DISPLAY_NAME:"显示名称",SET_DEFAULT:"设为默认语言",DEFAULT:"（当前默认）",ADD_LOCALE:"增加语言",DELETE:"删除",CONFIRM_DELETE:"您确定要删除吗？您的数据将会保留。",BLOG_NAME:"博客名称",BLOG_DESCRIPTION:"博客描述",SAVE:"保存",INFO:"信息",PAGE_SIZE:"每页数量",DATETIME_FORMAT:"日期格式"},editor:{TITLE:"标题",SUBTITLE:"副标题",SLUG:"别名",TIME:"发布时间",EXCERPT:"摘要",CONTENT:"正文",ADD_TAG:"添加标签",SAVE_PUBLISH:"保存并发布",SAVE_DRAFT:"保存为草稿",HEADER_IMAGE:"题图",COPY_FROM:"复制自"},tags:{NAME:"名称",ADD:"增加",ADD_PROMPT:"请输入新标签的别名"},users:{USERNAME:"用户名",EMAIL:"邮箱",NICKNAME:"昵称",PASSWORD:"密码",CHANGE_PASSWORD:"修改密码",OLD_PASSWORD:"原密码",NEW_PASSWORD:"新密码",CONFIRM_PASSWORD:"确认密码",OK:"确定",CANCEL:"取消",TWO_NOT_MATCH:"两次输入不匹配",OLD_NOT_MATCH:"旧密码错误"},blogrolls:{NAME:"名称",LINK:"链接"}};angular.module("Virblog",["ui.router","ngAnimate","pascalprecht.translate","ui.bootstrap","ngBootbox","localytics.directives","cgNotify","ui.bootstrap.datetimepicker","ui.codemirror","ngTable","ngTagsInput"]).config(["$stateProvider","$urlRouterProvider",function(t,e){e.when("/dashboard","/dashboard/posts"),e.otherwise("/login"),t.state("base",{"abstract":!0,url:"",templateUrl:"views/base.html"}).state("login",{url:"/login",parent:"base",templateUrl:"views/login.html",controller:"LoginCtrl",title:"login.LOGIN"}).state("dashboard",{url:"/dashboard",parent:"base",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).state("dashboard.posts",{url:"/posts",templateUrl:"views/dashboard/posts.html",controller:"PostsCtrl",resolve:{type:function(){return"Post"}},title:"nav.POSTS"}).state("dashboard.pages",{url:"/pages",templateUrl:"views/dashboard/posts.html",controller:"PostsCtrl",resolve:{type:function(){return"Page"}},title:"nav.PAGES"}).state("dashboard.editor",{url:"/edit/:slug?type",templateUrl:"views/dashboard/editor.html",controller:"EditorCtrl",title:"nav.EDIT"}).state("dashboard.tags",{url:"/tags",templateUrl:"views/dashboard/tags.html",controller:"TagsCtrl",title:"nav.TAGS"}).state("dashboard.settings",{url:"/settings",templateUrl:"views/dashboard/settings.html",controller:"SettingsCtrl",title:"nav.SETTINGS"}).state("dashboard.users",{url:"/users",templateUrl:"views/dashboard/users.html",controller:"UsersCtrl",title:"nav.USERS"}).state("dashboard.blogrolls",{url:"/blogrolls",templateUrl:"views/dashboard/blogrolls.html",controller:"BlogrollsCtrl",title:"nav.BLOGROLLS"})}]).config(["$translateProvider",function(t){t.translations("en",EN).translations("zh-Hans",ZH_HANS).registerAvailableLanguageKeys(["zh-Hans","en"],{"zh-CN":"zh-Hans","en-US":"en","en-UK":"en"}).fallbackLanguage("en").useSanitizeValueStrategy("escaped").uniformLanguageTag("bcp47").determinePreferredLanguage()}]).config(["$httpProvider",function(t){t.interceptors.push(["$q",function(t){return{responseError:function(e){return 401==e.status&&-1==window.location.href.indexOf("/login")&&(window.location.href="/admin/"),t.reject(e)}}}])}]).directive("updateTitle",["$rootScope","$timeout","$translate",function(t,e,s){return{link:function(a,o){var n=function(t,a){var n="Default Title";a.title&&(n=s.instant(a.title)),e(function(){o.text(n)},0,!1)};t.$on("$stateChangeSuccess",n)}}}]).directive("newScope",function(){return{scope:!0}}),angular.module("Virblog").controller("LoginCtrl",["$scope","$location","$http","$translate",function(t,e,s,a){s.get("/api/v1/user-info").success(function(){e.path("/dashboard")}),t.setLang=function(t){a.use(t)},t.submit=function(){return s.post("/api/v1/login",t.login).success(function(t){"ok"===t.status&&e.path("/dashboard")}).error(function(){t.authMsg="login.WRONG"}),!1}}]),angular.module("Virblog").controller("DashboardCtrl",["$scope","$rootScope","$state","$http",function(t,e,s,a){t.$state=s,a.get("/api/v1/user-info").success(function(s){if(s.email=s.email||"",s.nickname=s.nickname||"",e.user=s,s.email){var a=md5(s.email.trim().toLowerCase());t.avatar="//www.gravatar.com/avatar/"+a+"?s=160"}})}]),angular.module("Virblog").controller("PostsCtrl",["$scope","$http","$translate","type","$sce",function(t,e,s,a,o){function n(){e.get("/api/v1/posts?page="+t.currentPage+"&type="+a+"&status="+t.status).success(function(e){t.posts=e.data,t.count=e.count})}t.$translate=s,t.status="Published",t.locales=[],t.currentPage=1,t.title="nav."+a.toUpperCase()+"S",t.type=a,t.$watch("status",n),e.get("/api/v1/options").success(function(e){for(var s in e.locales)t.locales.push({code:s,name:e.locales[s]})}),t.unpublish=function(t){t.status="Draft",e.put("/api/v1/posts",t).success(function(){n()})},t.publish=function(t){t.status="Published",e.put("/api/v1/posts",t).success(function(){n()})},t.remove=function(t){e["delete"]("/api/v1/posts/"+t.slug).success(function(){n()})},t.pageChanged=n;var r={js:"javascript",html:"xml"},i=markdownit({highlight:function(t,e){if(r[e]&&(e=r[e]),e&&hljs.getLanguage(e))try{return hljs.highlight(e,t).value}catch(s){}return""}});t.render=function(t){return o.trustAsHtml(i.render(t||""))},e.get("/api/v1/options").success(function(e){t.settings=e})}]),angular.module("Virblog").controller("SettingsCtrl",["$scope","$http","$translate","$filter","notify",function(t,e,s,a,o){var n=t.availableLocales=[{code:"en",name:"English"},{code:"zh-Hans",name:"简体中文"},{code:"zh-Hant",name:"台灣繁體"}];t.$translate=s,t.locales=[],e.get("/api/v1/options").success(function(e){t.settings=e;for(var s in e.locales)t.locales.push({code:s,name:e.locales[s]})}),t.addLocale=function(){t.locales.push(a("filter")(n,{code:t.newLocale})[0]),t.newLocale=""},t.setDefaultLocale=function(e){t.settings.defaultLocale=e},t.removeLocale=function(e){t.locales.splice(e,1)},t.saveLang=function(){t.settings.locales={},t.locales.forEach(function(e){t.settings.locales[e.code]=e.name,t.settings.blogName[e.code]=t.settings.blogName[e.code]||"",t.settings.blogDescription[e.code]=t.settings.blogDescription[e.code]||"",t.settings.datetimeFormat[e.code]=t.settings.datetimeFormat[e.code]||""}),t.save()},t.save=function(){e.put("/api/v1/options",t.settings).success(function(){o({message:s.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3})}).error(function(){o({message:s.instant("FAILURE"),position:"right",classes:["alert-danger"],duration:3e3})})}}]),angular.module("Virblog").controller("EditorCtrl",["$scope","$http","$translate","$stateParams","notify","$q","$filter","$state",function(t,e,s,a,o,n,r,i){var l=a.slug;t.langKey=s.use(),t.locales=[],t.editorOptions={lineWrapping:!0,lineNumbers:!1,matchBrackets:!0,mode:"gfm",theme:"default",extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"}},t.tags=[],t["new"]=""===a.slug;var c={js:"javascript",html:"xml"},u=markdownit({highlight:function(t,e){if(c[e]&&(e=c[e]),e&&hljs.getLanguage(e))try{return hljs.highlight(e,t).value}catch(s){}return""}});e.get("/api/v1/tags").success(function(e){e.forEach(function(e){t.tags.push({text:e.slug})})}),t.loadTags=function(e){var s=n.defer();return s.resolve(r("filter")(t.tags,{text:e})),s.promise},e.get("/api/v1/options").success(function(e){t.settings=e;for(var s in e.locales)t.locales.push({code:s,name:e.locales[s]})}),t.post={time:new Date,subtitle:{},excerpt:{},content:{},postType:a.type,headerImage:""},t["new"]||e.get("/api/v1/posts/"+l).success(function(e){t.post=e,t.post._tags=[],e.tags.forEach(function(e){t.post._tags.push({text:e})})}),t.$watch("post.content[langKey]",function(){$("#content-preview").html(u.render(t.post.content[t.langKey]||""))}),t.$watch("post.excerpt[langKey]",function(){$("#excerpt-preview").html(u.render(t.post.excerpt[t.langKey]||""))}),t.save=function(){t.post.tags=[],"Post"==t.post.postType&&t.post._tags.forEach(function(e){t.post.tags.push(e.text)});var a=t["new"]?e.post:e.put;a("/api/v1/posts",t.post).success(function(){o({message:s.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3}),i.go("dashboard."+t.post.postType.toLowerCase()+"s")}).error(function(){o({message:s.instant("FAILURE"),position:"right",classes:["alert-danger"],duration:3e3})})},t.zhs2zht=function(s){var a={content:t.post[s]["zh-Hans"]};e.post("/api/v1/i18n/zhs2zht",a).success(function(e){t.post[s]["zh-Hant"]=e})}}]),angular.module("Virblog").controller("TagsCtrl",["$scope","$http","ngTableParams","notify","$ngBootbox","$translate",function(t,e,s,a,o,n){t.locales=[],e.get("/api/v1/options").success(function(e){t.locales=e.locales}),t.tableParams=new s({count:2},{counts:[],groupBy:"slug",total:0,getData:function(s){var a=[];e.get("/api/v1/tags").success(function(e){e.forEach(function(e){for(var s in t.locales)a.push({slug:e.slug,code:s,name:e.name[s]||""})}),s.resolve(a)})}}),t.add=function(){o.prompt(n.instant("tags.ADD_PROMPT")).then(function(e){var s=[];for(var a in t.locales)s.push({slug:e,code:a,name:""});t.tableParams.data.push({value:e,data:s})})},t.save=function(){var s=t.tableParams.data,o=[];s.forEach(function(t){var e={};t.data.forEach(function(t){e[t.code]=t.name}),o.push({slug:t.value,name:e})}),e.put("/api/v1/tags",o).success(function(){a({message:n.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3})}).error(function(){a({message:n.instant("FAILURE"),position:"right",classes:["alert-danger"],duration:3e3})})}}]),angular.module("Virblog").controller("UsersCtrl",["$scope","$http","$translate","$filter","notify","$rootScope","$modal",function(t,e,s,a,o,n,r){t.save=function(){e.put("/api/v1/users/update",{email:n.user.email,nickname:n.user.nickname}).success(function(){o({message:s.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3})}).error(function(){o({message:s.instant("FAILURE"),position:"right",classes:["alert-danger"],duration:3e3})})},t.open=function(){r.open({animation:!1,templateUrl:"ChangePassword",controller:"ChangePasswordCtrl"})}}]).controller("ChangePasswordCtrl",["$scope","$rootScope","notify","$modalInstance","$http","$translate",function(t,e,s,a,o,n){t.passwords={},t.ok=function(){o.put("/api/v1/users/update-password",{old:t.passwords.old,"new":t.passwords["new"]}).success(function(){a.close(),s({message:n.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3})}).error(function(){t.mismatch=!0})},t.cancel=function(){a.dismiss()}}]).directive("pwCheck",[function(){return{require:"ngModel",link:function(t,e,s,a){var o="#"+s.pwCheck;e.add(o).on("keyup",function(){t.$apply(function(){var t=e.val()===$(o).val();a.$setValidity("pwmatch",t)})})}}}]),angular.module("Virblog").controller("BlogrollsCtrl",["$scope","$http","notify","$translate",function(t,e,s,a){e.get("/api/v1/blogrolls").success(function(e){t.blogrolls=e}),t.add=function(){t.blogrolls.push({name:"",link:""})},t.remove=function(e){t.blogrolls.splice(e,1)},t.save=function(){e.post("/api/v1/blogrolls",t.blogrolls).success(function(){s({message:a.instant("SUCCESS"),position:"right",classes:["alert-success"],duration:3e3})}).error(function(){s({message:a.instant("FAILURE"),position:"right",classes:["alert-danger"],duration:3e3})})}}]);